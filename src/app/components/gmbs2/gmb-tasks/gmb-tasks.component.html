<div class="text-center">
  <h1 class="text-center">GMB Tasks ({{tasks.length}})</h1>
  <button class="btn btn-link" (click)="populate()" [qLoading]="apiLoading">
    <i class="fas fa-sync-alt"></i> Reload</button>
  <div class="text-center">
    <span class="alert-warning">* Please Reload Before Claiming and Handling Your Tasks</span>
  </div>
</div>
<div class="clearfix mt-2">
  <div class="float-left form-inline">


  </div>
  <div class="float-right">
  </div>
</div>

<div class="card text-center mb-4" *ngIf="currentAction !== 'ADD'">
  <div class="card-header">
    <ul class="nav nav-tabs card-header-tabs">
      <li class="nav-item" *ngFor="let tab of tabs" style="cursor: pointer;">
        <a class="nav-link {{activeTabLabel === tab.label? 'active' : ''}}"
          (click)="setActiveTab(tab)">{{tab.label}}({{tab.rows.length}})</a>
      </li>
    </ul>
  </div>
  <div class="clearfix mt-2">

    <label class="mr-2"> Time Zone:</label>
    <select class="mr-2" [(ngModel)]="timeZone" (change)="filter()">
      <option>All</option>
      <option *ngFor="let tz of timeZoneList">{{tz}}</option>
    </select>
    <label class="mr-2"> GMB Owner:</label>
    <select class="mr-2" [(ngModel)]="owner" (change)="filter()">
      <option>All</option>
      <option>NON-QMENU</option>
      <option *ngFor="let ow of ownerList">{{ow}}</option>
    </select>

    <label class="mr-2"> Assignee:</label>
    <select class="mr-2" [(ngModel)]="assignee" (change)="filter()">
      <option>All</option>
      <option *ngFor="let assignee of assignees">{{assignee}}</option>
    </select>

    <label class="mr-2"> Owner Declined:</label>
    <select class="mr-2" [(ngModel)]="ownerDeclined" (change)="filter()">
      <option>Any</option>
      <option>Yes</option>
      <option>No</option>
    </select>

    <label class="mr-2"> Published:</label>
    <select class="mr-4" [(ngModel)]="verified" (change)="filter()">
      <option>No</option>
      <option>Yes</option>
      <option>Any</option>
    </select>

    <input class="form-check-input" type="checkbox" [(ngModel)]="shouldCall" id="shouldCallCheck" (change)="filter()">
    <label class="form-check-label mr-4" for="shouldCallCheck">
      Should Call
    </label>

    <input class="form-check-input" type="checkbox" [(ngModel)]="hasPhone" id="hasPhoneCheck" (change)="filter()">
    <label class="form-check-label mr-2" for="hasPhoneCheck">
      Phone
    </label>

    <label class="mr-2"> Postcard:</label>
    <select class="mr-4" [(ngModel)]="postcardFilter" (change)="filter()">
      <option>Not Sent</option>
      <option>Sent</option>
      <option>Any</option>
    </select>

    <input class="form-check-input" type="checkbox" [(ngModel)]="hasCourier" id="hasCourier" (change)="filter()">
    <label class="form-check-label mr-5" for="hasCourier">
      Courier
    </label>

    <input class="form-check-input" type="checkbox" [(ngModel)]="pagination" id="paginationCheck">
    <label class="form-check-label mr-5" for="paginationCheck">
      Pagination
    </label>

  </div>

  <div class="card-body text-left">
    <ng-container *ngFor="let tab of tabs">
      <q-table *ngIf="activeTabLabel === tab.label" [rows]="tab.rows" [tableColumnDescriptors]="myColumnDescriptors"
        [compact]="true" [pageSize]="pagination ? 100 : 100000">

        <tr *tableRowTemplate="let row;"
          class="{{row.request.ownerDeclined || (row.request.statusHistory && row.request.statusHistory[0].isError) ? 'alert-danger': ''}}">
          <td>{{row.rowNumber}}
          </td>
          <td>
            <div class="badge badge-{{row.statusClass}}">{{(row.scheduledAt || 0) | ago: now}}</div>
          </td>

          <td>
            <a target="_blank"
              href="#/restaurants/{{row.relatedMap?.restaurantId}}">{{row.relatedMap?.restaurantName}}</a>
            <i class="fa fa-taxi" *ngIf="row.courier"></i>
            <div class="text-muted">
              <small>
                {{row.address}}
                <div>{{row.localTimeString}}</div>
                <!-- <div *ngIf="task.transfer && task.transfer.fromEmail">
                      <app-gmb-account-hotlink [email]="task.transfer.fromEmail"></app-gmb-account-hotlink>
                      <span *ngIf="task.transfer.againstEmail">« {{task.transfer.againstEmail | emailName}}</span>
                    </div>
                    <div *ngIf="task.etc && task.etc.fromEmail">
                      <app-gmb-account-hotlink [email]="task.etc.fromEmail"></app-gmb-account-hotlink>
                    </div> -->
              </small>
            </div>
          </td>
          <td>{{row.timezoneCell}}</td>
          <td>{{row.score | number : '1.0-0'}}</td>
          <td>{{row.gmbOwner}}</td>
          <td class="text-nowrap">
            <i *ngIf="row.request?.pinHistory && row.request?.pinHistory[0] && row.request?.pinHistory[0].pin"
              class="text-warning fas fa-2x fa-lightbulb"></i>
            <ng-container *ngFor="let vo of row.verificationOptions || []">
              <i
                class="fas fa-{{vo.verificationMethod === 'EMAIL' ? 'at' : (vo.verificationMethod === 'PHONE_CALL' ? 'phone' : (vo.verificationMethod === 'ADDRESS' ? 'address-card' : 'question'))}} {{vo.verification ? 'text-success' : 'text-muted'}} {{isNonQmenuEmail(vo) ? 'opacity-30' : ''}}"></i>
            </ng-container>

            <div *ngIf="row.pendingVerification" class="text-muted">
              <small>{{row.pendingVerification.createTime | ago: now}}</small>
            </div>

            <!-- <div class="text-warning" *ngIf="task.transfer?.code">
                  <i class="fas fa-2x fa-lightbulb"></i>
                </div>-->
          </td>
          <td>{{row.assignee}}</td>
          <td>
            <!-- <app-task-action-bar [task]="row.task" [user]="user" (actionDone)="triggerActionDone($event)">
            </app-task-action-bar> -->
            <button class="btn btn-primary" *ngIf="!row.assignee" (click)="assign(row.task, user.username)">
              Claim
            </button>
            <button class="btn btn-link" (click)="showDetails(row.task._id)">
              Details
            </button>
          </td>
          <td class="text-nowrap">
            {{row.createdAt | ago:now}}
            <div class="text-muted">
              <small>{{row._id}}</small>
            </div>
          </td>
          <td class="text-nowrap">
            <div *ngIf="row.request && row.request.refreshedAt" class="text-muted">
              <small>{{row.request.refreshedAt | ago: now}}</small>
            </div>
          </td>
          <td>
            <div *ngIf="row.request?.statusHistory && row.request?.statusHistory[0]">
              <!-- {{row.request.statusHistory[0].status}} -->
              {{row.request.statusHistory[0]?.status}}
            </div>
            <div class="wrap" [innerHTML]="row.comments"> </div>
          </td>
        </tr>
      </q-table>
    </ng-container>

  </div>
</div>

<!--the editing modal-->
<q-modal #rowModal>
  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
    <span aria-hidden="true">×</span>
  </button>
 
  <app-gmb-task-detail #taskDetail [qmenuDomains]="qmenuDomains" [publishedCids]="publishedCids"
  [assignees]="assignees" (refreshTask)="handleRefreshSingleTask($event)"
  (assignComplete)="handleAssignComplete()" (showDetailsEvent)="showDetails($event)"></app-gmb-task-detail> 
</q-modal>