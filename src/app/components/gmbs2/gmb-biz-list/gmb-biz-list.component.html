<h2 class="text-center">GMB: Restaurants <small>{{filteredMyBizList.length}}</small></h2>
<div class="clearfix my-2">
  <div class="float-left form-inline">
    <input [qDebounce]="500" (debounce)="debounce($event)" type="text" class="form-control mr-4" placeholder="type name, phone, account..."
      [(ngModel)]="searchFilter">

    <label class="mr-2"> GMB:</label>
    <select class="form-control mr-4" [(ngModel)]="gmbOwnership" (change)="filterBizList()">
      <option>any</option>
      <option>qmenu</option>
      <option>NOT qmenu</option>

    </select>

    <label class="mr-2"> Google Listing:</label>
    <select class="form-control mr-4" [(ngModel)]="googleListingOwner" (change)="filterBizList()">
      <option>any</option>
      <option>qmenu</option>
      <option>NOT qmenu</option>
    </select>

    <div class="form-check ml-4">
      <input class="form-check-input" type="checkbox" [(ngModel)]="notScanned3" (change)="filterBizList()" id="notScannedCheckbox">
      <label class="form-check-label" for="notScannedCheckbox">
        Not Scanned in 3 Days {{notScanned3}}
      </label>
    </div>

    <div class="form-check ml-4">
      <input class="form-check-input" type="checkbox" [(ngModel)]="onlyLost" (change)="filterBizList()" id="lostCheckbox">
      <label class="form-check-label" for="lostCheckbox">
        Only lost
      </label>
    </div>

  </div>
  <div class="float-right">
    <button class="btn btn-primary" (click)="refresh()" [qLoading]="refreshing">
      <i class="fas fa-sync-alt"></i> Reload</button>
    <button class="btn btn-primary" (click)="crawlAll()" [qLoading]="crawling">
      <i class="fab fa-google"></i> Crawl All</button>
  </div>
</div>

<q-table [rows]="filteredMyBizList" [tableColumnDescriptors]="myColumnDescriptors" [compact]="true">
  <!-- <tr *tableRowTemplate="let biz;" [ngClass]="{'list-group-item-danger': !biz.owned }"> -->
  <tr *tableRowTemplate="let biz;">
    <td>
      <div class="dropdown">
        <button class="btn btn-link dropdown-toggle font-weight-bold pl-0" type="button" data-toggle="dropdown">
          {{biz.gmbBiz.name}}
        </button>
        <div class="dropdown-menu">
          <a class="dropdown-item" target="_blank" href="#/restaurants/{{biz.gmbBiz.qmenuId}}">qMenu Restaurant Details</a>
          <a class="dropdown-item" target="_blank" href="https://www.google.com/search?q={{getEncodedGoogleSearchString(biz.gmbBiz)}}">Google
            Listing
          </a>
        </div>
      </div>
      <div class="text-muted">
        <small>{{biz.gmbBiz.address}}</small>
      </div>

      <small class="text-muted text-nowrap">{{biz.gmbBiz.phone | tel}}</small>
    </td>
    <td>
      <ng-container *ngIf="biz.qmenuIdDays">{{biz.qmenuIdDays}} days</ng-container>
      <div class="badge badge-pill badge-danger" *ngIf="biz.lostDate">
        <small>Lost: {{biz.lostDate | ago: now}}</small>
      </div>
    </td>
    <td>{{biz.gmbBiz.score}}</td>
    <!-- <td>{{biz.ownershipPercentage}}%</td> -->
    <td>
      <small>{{biz.transfers}}</small>
    </td>
    <td class="text-center">
      <img *ngIf="biz.owned" [attr.src]="'/assets/images/qmenu.png'" alt="qmenu" height="16px">
      <span *ngIf="!biz.owned">?</span>
    </td>
    <td class="text-center">
      <a href="{{biz.gmbBiz.gmbWebsite}}" title="{{biz.gmbBiz.gmbWebsite}}" target="_blank">
        <i *ngIf="!getLogo(biz.gmbBiz) && biz.gmbBiz.gmbOwner" class="fas fa-question text-danger"></i>
        <img *ngIf="getLogo(biz.gmbBiz)" [attr.src]="'/assets/images/' + getLogo(biz.gmbBiz)" [attr.alt]="biz.gmbBiz.gmbOwner" height="16px">
        <i class="fas fa-lock-open text-info" *ngIf="biz.gmbBiz.gmbOpen"></i>
      </a>
    </td>
    <td>
      <div *ngIf="biz.gmbBiz.crawledAt" class="text-muted text-nowrap">
        <small>{{biz.gmbBiz.crawledAt | ago: now}}</small>
      </div>
    </td>
    <td>
      {{getOutstandingTasks(biz.gmbBiz)}}
    </td>
    <td class="text-center">
      <div class="dropdown">
        <button class="btn btn-outline-primary dropdown-toggle" data-toggle="dropdown">
          Action...
        </button>
        <div class="dropdown-menu dropdown-menu-right">
          <button class="dropdown-item" [qLoading]="isProcessing(biz.gmbBiz)" (click)="inject(biz.gmbBiz)">Inject qMenu</button>
          <button class="dropdown-item" [qLoading]="isProcessing(biz.gmbBiz)" (click)="crawl(biz.gmbBiz)">G-Crawl</button>
          <button class="dropdown-item" [qLoading]="isProcessing(biz.gmbBiz)" (click)="createApplyTask(biz.gmbBiz)">Create Apply-GMB Task</button>
          <button class="dropdown-item" [qLoading]="isProcessing(biz.gmbBiz)" (click)="injectScore(biz.gmbBiz)">Inject Score</button>
          <button class="dropdown-item" (click)="edit(biz.gmbBiz)">Edit</button>
        </div>
      </div>

    </td>
  </tr>
</q-table>
<hr>
<div class="text-success mb-4">âœ“: GMB Requests Ignored (usually qMenu partners)</div>
<!--the editing modal-->
<q-modal #bizEditingModal>
  <h4 class="text-center">{{bizInEditing && bizInEditing._id ? 'Update' : 'Add New'}}</h4>
  <hr>
  <app-gmb-biz-editor [gmbBiz]="bizInEditing" (remove)="remove($event)" (submit)="done($event)" (cancel)="cancel()"></app-gmb-biz-editor>
  <div class="text-danger">{{apiError}}</div>
</q-modal>
