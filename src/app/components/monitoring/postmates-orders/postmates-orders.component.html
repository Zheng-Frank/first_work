<div class="card">
  <h2 class="card-title m-3">
    <h1 class="text-center">Postmates Orders</h1>
  </h2>
  <div class="card-body">
    <div *ngIf="orders">
      <div class="form-inline">
        <label class="text-center pl-5"
          style="line-height: 35px; vertical-align: center;min-width:200px;max-width:200px;"> Search order by:
        </label>
        <select [(ngModel)]="type" class="form-control mr-3 col-2" style="min-width:180px;max-width:180px;">
          <option *ngFor="let type of searchTypes" [value]="type">{{type}}</option>
        </select>
        <input *ngIf="showOrderSearchInput()" type="text" [(ngModel)]="searchText" style="min-width:300px;max-width:300px;" class="form-control col-7"
          placeholder="Please input">
        <div class="form-inline" *ngIf="showAdvancedSearch">
          <select [(ngModel)]="dateType" class="form-control mr-3 ml-2">
            <option *ngFor="let type of dateSearchTypes">{{type}}</option>
          </select>
          <button class="btn btn-primary ml-2" *ngIf="dateType !== 'Custom'" (click)="searchOrderByDate()"><i
              class="fa fa-search"></i>Search</button>
          <ng-container *ngIf="dateType === 'Custom'">
            <input class="form-control" type="date" [(ngModel)]="fromDate">
            <button class="btn btn-primary ml-2" (click)="doSearchOrderByDateCustom()"><i
                class="fa fa-search"></i>Search</button>
          </ng-container>
        </div>
        <button class="btn btn-primary ml-2 mb-1" *ngIf="!showAdvancedSearch" (click)="search()">
          <i class="fa fa-search"></i> Search
        </button>
        <div class="text-muted float-left col-1">Found: {{orders.length}}
          <i class="fa fa-info-circle icon-color" (mouseover)="showExplanation = true"
            (mouseout)="showExplanation = false">
            <div *ngIf="showExplanation" class="left talk radius">
              <p>
                The latest 50 orders will be displayed in first query and can only display orders up to 200. If unable to find a Postmates order when searching by date, this may be due to use of EST timezone.
              </p>
              -------------<br>
              <p>在第一次查询中只显示最新的50个订单，并且最多只能显示200条最新的订单。如果在按日期搜索时找不到邮递订单，这可能是由于使用了EST时区。</p>
            </div>
          </i>
        </div>
      </div>
      <div class="form-group">
        <button type="button" class="btn btn-link ml-5" (click)="toggleShowAdvancedSearch()">
          {{ showAdvancedSearch?'Hide advanced search..':'Show advanced search..'}}</button>
      </div>

      <div class="row ml-0 mr-0">
        <!-- row has negative margins and we need to remove them! -->
        <div *ngFor="let order of orders" class="col-sm-12 col-md-6 col-lg-4  app-pl-025 app-pr-025 mb-1">
          <app-postmates-order-card [restaurant]="order.restaurant" [order]="order"
            (onSetNewStatus)="handleOnSetNewStatus($event)" (onReject)="handleOnReject($event)"
            (onUndoReject)="handleOnUndoReject($event)" (onBan)="handleOnBan($event)"
            (onDisplayCreditCard)="handleOnDisplayCreditCard($event)" (onAdjust)="handleOnAdjust($event)"
            (onOpenPreviousCanceledOrderModal)="handleOnOpenPreviousCanceledOrderModal($event)"
            (onOpenChangeOrderTypesModal)="handleOpenChangeOrderTypesModal($event)"
            (onAdjustInvoice)="handleOnAdjustInvoice($event)"
            (onOpenPreviousOrdersModal)="handleOnOpenPreviousOrdersModal($event)">
          </app-postmates-order-card>
        </div>
      </div>

      <!-- change order type q-modal to select two type of order type -->
      <q-modal #changeOrderTypeModal style="margin-top: 160px;">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
        <h4 class="text-center">Change Order Type</h4>
        <hr>
        <div class="container">
          <div class="row mb-3">
            <div class="col-12">
              <select [(ngModel)]="changeOrderType" class="form-control">
                <option value="Customer Pickup">Customer Pickup</option>
                <option value="Restaurant self-deliver">Restaurant self-deliver</option>
              </select>
            </div>
          </div>
        </div>
        <div class="d-flex justify-content-end p-4">
          <button class="btn btn-secondary mr-2" (click)="changeOrderTypeModal.hide()">Cancel</button>
          <button class="btn btn-primary" (click)="handleOnChangeOrderTypes()">Submit</button>
        </div>

      </q-modal>

      <!-- start previous canceled order q-modal -->
      <q-modal #previousCanceledOrderModal>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
        <h4 class="text-center">Previous Canceled Order</h4>
        <hr>
        <!-- row has negative margins and we need to remove them! -->
        <app-postmates-order-card [restaurant]="previousCanceledOrder?.restaurant" [order]="previousCanceledOrder"
          (onSetNewStatus)="handleOnSetNewStatus($event)" (onReject)="handleOnReject($event)"
          (onUndoReject)="handleOnUndoReject($event)" (onBan)="handleOnBan($event)"
          (onDisplayCreditCard)="handleOnDisplayCreditCard($event)" (onAdjust)="handleOnAdjust($event)"
          (onOpenChangeOrderTypesModal)="handleOpenChangeOrderTypesModal($event)"
          (onAdjustInvoice)="handleOnAdjustInvoice($event)">

        </app-postmates-order-card>
      </q-modal>
      <!-- end previous canceled order q-modal -->

      <!-- start previous orders q-modal -->
      <q-modal #previousOrdersModal>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
        <h4 class="text-center">Previous Orders</h4>
        <hr>
        <div class="row alert alert-danger m-1 p-1" style="border-radius:2px;">
          Only up to the latest 10 orders from a customer will be displayed.(仅显示来自客户的最新10个订单。)
        </div>
        <!-- row has negative margins and we need to remove them! -->
        <ng-container *ngFor="let previousOrder of previousOrders">
          <app-postmates-order-card [restaurant]="previousOrder?.restaurant" [order]="previousOrder"
            (onSetNewStatus)="handleOnSetNewStatus($event)" (onReject)="handleOnReject($event)"
            (onUndoReject)="handleOnUndoReject($event)" (onBan)="handleOnBan($event)"
            (onDisplayCreditCard)="handleOnDisplayCreditCard($event)" (onAdjust)="handleOnAdjust($event)"
            (onOpenChangeOrderTypesModal)="handleOpenChangeOrderTypesModal($event)"
            (onAdjustInvoice)="handleOnAdjustInvoice($event)">

          </app-postmates-order-card>
        </ng-container>
      </q-modal>
      <!-- end previous orders q-modal -->

      <q-modal #paymentModal>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
        <div class="clearfix"></div>
        <hr>
        <p>{{payment.explanation}}</p>
        <table class="table-borderless">
          <tr>
            <th>Payment Type</th>
            <td>{{payment.paymentType}}</td>
          </tr>
          <tr *ngIf="payment.card">
            <th>Customer Name</th>
            <td>{{payment.card.firstName + ' ' + (payment.card.lastName || '')}}</td>
          </tr>
          <tr *ngIf="payment.card">
            <th>Card Number</th>
            <td>{{getFormattedCreditCardNumber(payment.card.cardNumber)}}</td>
          </tr>
          <tr *ngIf="payment.card">
            <th>Card Expiry</th>
            <td>{{payment.card.expiryMonth + '/' + payment.card.expiryYear}}</td>
          </tr>
          <tr *ngIf="payment.card">
            <th>Card CVC</th>
            <td>{{payment.card.cvc || 'N/A'}}</td>
          </tr>
          <tr *ngIf="payment.card && payment.card.zipcode">
            <th>Zip Code</th>
            <td>{{payment.card.zipcode || 'N/A'}}</td>
          </tr>
          <tr *ngIf="payment.card && payment.card.billingAddress && payment.card.billingAddress.place_id">
            <th>Billing Address</th>
            <td>
              {{payment.card.billingAddress?.apt}} {{payment.card.billingAddress?.formatted_address}}
            </td>
          </tr>
        </table>
        <button class="btn btn-lg btn-block btn-secondary" data-dismiss="modal">OK</button>
      </q-modal>

      <q-modal #rejectModal>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
        <h4 class="text-center">Reject Order</h4>
        <hr>
        <app-order-reject-bar [order]="orderForModal" (onReject)="rejectOrder($event)"></app-order-reject-bar>
        <hr>
        <div *ngIf="!!cancelError" class="d-flex flex-column align-items-center">
          <span class="text-primary">ATTENTION</span>
          <p class="text-primary">{{cancelError}}</p>
        </div>

        <div *ngIf="isPostmatesStatusDelivered" class="d-flex flex-column align-items-center">
          <span class="text-primary">ATTENTION</span>
          <p class="text-primary">Note that the Postmates status of this order <span
              class="font-weight-bold">delivered.</span><br />Please be sure you want to cancel it before proceeding.
          </p>
        </div>
      </q-modal>

      <q-modal #undoRejectModal>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
        <h4 class="text-center">Undo Reject Order</h4>
        <hr>
        <p class="text-center">Are you sure to undo cancel order?</p>
        <div class="d-flex justify-content-end p-4">
          <button class="btn btn-secondary mr-2" (click)="undoRejectModal.hide()">No</button>
          <button class="btn btn-primary" (click)="undoRejectOrder()">Yes</button>
        </div>

      </q-modal>

      <q-modal #banModal>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
        <h4 class="text-center">BAN CUSTOMER</h4>
        <hr>
        <div class="alert-danger">USE EXTREME CAUTION: The customer
          <b>{{orderForModal?.customer?.firstName}} {{orderForModal?.customer?.phone | tel}}</b> will be banned
          permanently
          from placing any orders in future!</div>
        <div class="alert-success mt-1 mt-1">Banned customers will NOT see the reasons.</div>

        <h5 class="pt-1 pb-1">Reasons (check all that applies)</h5>
        <app-ban-customer (onBan)="okBan($event)"></app-ban-customer>

      </q-modal>

      <q-modal #adjustModal>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
        <h4 class="text-center">Adjustment</h4>
        <hr>
        <app-order-adjustment (submit)="submitAdjustment($event)"></app-order-adjustment>
      </q-modal>

      <q-modal #adjustInvoiceModal>
        <button type="button" class="close" (click)="cancelAdjustInvoice()">
          <span aria-hidden="true">×</span>
        </button>
        <h4 class="text-center">Invoice Adjustment</h4>
        <hr>
        <app-restaurant-invoice-adjustment #adjustInvoiceComponment [restaurant]="orderForModal?.restaurant"
          [log]="logInEditing" [order]="orderForModal" (onAdjustInvoice)="doAdjustInvoice($event)"
          (onCancel)="cancelAdjustInvoice()">
        </app-restaurant-invoice-adjustment>

      </q-modal>
    </div>
  </div>
</div>
