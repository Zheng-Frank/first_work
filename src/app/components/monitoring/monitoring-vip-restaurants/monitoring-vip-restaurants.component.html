<div class="card">
  <h2 class="card-title m-3">
    <h1 class="text-center">VIP Restaurants ({{filterVipRTs.length || 0}})</h1>
  </h2>
  <div class="card-body">
    <div class="row mb-3">
      <div class="col-auto">
        <div class="input-group d-flex align-items-center">
          <label class="mr-2 mb-0">View</label>
          <select [(ngModel)]="viewMode" class="custom-select"
                  (change)="filter()">
            <option *ngFor="let mode of viewModes" [value]="mode">{{mode}}</option>
          </select>
        </div>
      </div>
      <div class="col-auto" *ngIf="viewMode !== viewTypes.All">
        <div class="input-group d-flex align-items-center">
          <label class="mr-2 mb-0">Rule: Followup every</label>
          <select [(ngModel)]="rule" class="custom-select"
                  (change)="filter()">
            <option *ngFor="let r of rules" [value]="r">{{r}}</option>
          </select>
        </div>
      </div>
      <div class="col-auto">
        <div class="input-group d-flex align-items-center">
          <select [(ngModel)]="vipRange" class="custom-select"
                  (change)="filter()">
            <option value="">All</option>
            <option *ngFor="let range of vipRanges" [value]="range">{{range}}</option>
          </select>
        </div>
      </div>
      <div class="col-auto">
        <button class="btn btn-primary" (click)="loadVIPRestaurants()"><i class="fas fa-sync"></i> Reload</button>
      </div>
    </div>
    <!-- end with filter control -->

    <div class="row">
      <a class="btn btn-link" (click)="showStats = !showStats" >Show Stats <i class="fa fa-angle-{{showStats ? 'up': 'down'}}"></i></a>
    </div>
    <div [ngClass]="{'hide': !showStats}">
      <div class="mb-3">
        <canvas width="1000" height="240" #chartOC ></canvas>
      </div>
      <div class="mb-3">
        <canvas width="1000" height="240" #chartRT ></canvas>
      </div>
    </div>

    <div class="row mb-3">
      <a class="btn btn-link" (click)="showChurn = !showChurn">Show VIP Churn <i class="fa fa-angle-{{showChurn ? 'up': 'down'}}"></i></a>
    </div>
    <div class="mb-3" *ngIf="showChurn">
      <table class="table table-sm">
        <thead>
          <tr>
            <th class="text-transparent"></th>
            <th>Start Count</th>
            <th>Total Lost</th>
            <th>Total Gained</th>
            <th>End Count</th>
            <th>Net +/- (%)</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of churnList">
            <td>{{item.month}}</td>
            <td>{{item.start}}</td>
            <td>{{item.lost}}</td>
            <td>{{item.gained}}</td>
            <td>{{item.end}}</td>
            <td>{{item.end - item.start}} ({{((item.end - item.start) / item.start) | percent: '1.0-2'}})</td>
          </tr>
        </tbody>
      </table>
    </div>

    <hr />

    <q-table [rows]="filterVipRTs" [tableColumnDescriptors]="restaurantsColumnDescriptors" [compact]="true"
      [pageSize]="100000">
      <tr *tableRowTemplate="let r;">
        <td>{{filterVipRTs.indexOf(r) + 1}}</td>
        <td>
          <a target="_blank" routerLink="/restaurants/{{r['_id']}}">{{r.name}} </a><br>
          <span>{{r._id}}</span>
        </td>
        <td>{{r.score}}</td>
        <td>{{r.avgAll | money}}</td>
        <td>{{r.avg3M | money}}</td>
        <td>
          <ng-container *ngIf="r?.googleAddress && r?.googleAddress?.timezone;else elseBlock;">
            {{getTimezoneCity(r.googleAddress.timezone)}}
            ({{getTimeOffsetByTimezone(r.googleAddress.timezone)}})
          </ng-container>
          <ng-template #elseBlock>
            N/A
          </ng-template>
        </td>
        <td>
          <ng-container *ngIf="r.lastFollowUp">
            <label>{{r.lastFollowUp | date : 'shortDate'}} ({{r.lastFollowUp | ago: now}})</label>
            <div class="text-success" *ngIf="!followUpOverdue(r)">Followup in: {{getOverdueDays(r, followUpOverdue(r))}} days</div>
            <div class="text-danger" *ngIf="followUpOverdue(r)">Followup overdue by: {{getOverdueDays(r, followUpOverdue(r))}} days</div>
          </ng-container>
          <ng-container *ngIf="!r.lastFollowUp">
            N/A
            <div class="text-warning">Need Follow up</div>
          </ng-container>
        </td>
        <td style="width:40%;">
          <table class="table table-sm">
            <tr>
              <th>User</th>
              <th>Time</th>
              <th>Problem</th>
              <th>Response</th>
            </tr>
            <ng-container *ngFor="let log of r.logs">
              <tr *ngIf="log.type === 'vip-follow-up'">
                <td>{{log.username}}</td>
                <td>{{log.time | adjustedDate : 'MMM d h:mm a' : r.googleAddress.timezone}}</td>
                <td>{{log.problem}}</td>
                <td>{{log.response}}</td>
              </tr>
            </ng-container>
          </table>
          <div>
            <button class="btn btn-primary btn-sm" (click)="addLog(r)"><i class="fas fa-plus"></i>Add Log</button>
          </div>
        </td>
    </q-table>
  </div>

  <q-modal #logEditingModal>
    <app-log-editor [restaurant]="activeRestaurant" [restaurantList]="[]" [log]="logInEditing"
      (success)="onSuccessAddLog($event)" (cancel)="onCancelAddLog()"></app-log-editor>
  </q-modal>
</div>
