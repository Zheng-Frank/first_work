<div *ngIf="cycle">
  <h1 class="text-center">{{cycle.toDate}}</h1>
  <!-- <button (click)="resetDangling()">reset dangling</button> -->
  <div class="text-right mb-2">
    <!-- <button class="btn btn-primary" (click)="fix()">
      <i class="fas fa-sync"></i> Fix</button> -->
    <button class="btn btn-primary" (click)="loadCycle(id)">
      <i class="fas fa-sync"></i> Reload</button>
  </div>
  <!-- {{sortingDirection}} {{sortingColumn}} -->
  <table class="table table-bordered text-center">
    <tbody>
      <tr>
        <td colspan="8" class="hvr-underline-reveal d-table-cell {{activeBlockName ==='ALL' ? 'alert-secondary' : ''}}"
          (click)="setActiveBlockName('ALL')">
          {{blocks.ALL.label}}
          <h2>{{blocks.ALL.rows.length}}</h2>
          <div class="text-danger">{{blocks.ALL.rows.length - blocks.INVOICES.rows.length - blocks.SKIPPED.rows.length}}
            Unprocessed</div>
        </td>
      </tr>
      <tr>
        <td colspan="4"
          class="w-50 hvr-underline-reveal d-table-cell {{activeBlockName ==='INVOICES' ? 'alert-secondary' : ''}}"
          (click)="setActiveBlockName('INVOICES')">
          {{blocks.INVOICES.label}}
          <h2>{{blocks.INVOICES.rows.length}}</h2>
        </td>
        <td colspan="4"
          class="w-50 hvr-underline-reveal d-table-cell {{activeBlockName ==='SKIPPED' ? 'alert-secondary' : ''}}"
          (click)="setActiveBlockName('SKIPPED')">
          {{blocks.SKIPPED.label}}
          <h2>{{blocks.SKIPPED.rows.length}}</h2>
        </td>
      </tr>
      <tr>
        <td class="hvr-underline-reveal d-table-cell {{activeBlockName ==='PAYOUT_INVOICES' ? 'alert-secondary' : ''}}"
          (click)="setActiveBlockName('PAYOUT_INVOICES')" style="width: 12.5%">
          {{blocks.PAYOUT_INVOICES.label}}
          <h2>{{blocks.PAYOUT_INVOICES.rows.length}}</h2>
          <div>
            sent: {{blocks.PAYOUT_INVOICES.sent || 0}}
          </div>
          <div class="text-success">
            paid: {{blocks.PAYOUT_INVOICES.paid || 0}}
          </div>
          <div class="text-success">
            {{getBlockAmount(blocks.PAYOUT_INVOICES) | currency:'USD':'symbol'}}
          </div>
        </td>
        <td class="hvr-underline-reveal d-table-cell {{activeBlockName ==='NORMAL_INVOICES' ? 'alert-secondary' : ''}}"
          (click)="setActiveBlockName('NORMAL_INVOICES')" style="width: 12.5%">
          {{blocks.NORMAL_INVOICES.label}}
          <h2>{{blocks.NORMAL_INVOICES.rows.length}}</h2>
          <div>
            sent: {{blocks.NORMAL_INVOICES.sent || 0}}
          </div>
          <div class="text-success">
            paid: {{blocks.NORMAL_INVOICES.paid || 0}}
          </div>
        </td>

        <td
          class="hvr-underline-reveal d-table-cell {{activeBlockName ==='CANCELED_INVOICES' ? 'alert-secondary' : ''}}"
          (click)="setActiveBlockName('CANCELED_INVOICES')" style="width: 12.5%">
          {{blocks.CANCELED_INVOICES.label}}
          <h2 class="text-danger">{{blocks.CANCELED_INVOICES.rows.length}}</h2>
          <div>
            sent: {{blocks.CANCELED_INVOICES.sent || 0}}
          </div>
          <div class="text-success">
            paid: {{blocks.CANCELED_INVOICES.paid || 0}}
          </div>
        </td>

        <td class="hvr-underline-reveal d-table-cell {{activeBlockName ==='ERROR_INVOICES' ? 'alert-secondary' : ''}}"
          (click)="setActiveBlockName('ERROR_INVOICES')" style="width: 12.5%">
          {{blocks.ERROR_INVOICES.label}}
          <h2 class="text-danger">{{blocks.ERROR_INVOICES.rows.length}}</h2>
        </td>
        <td style="width: 12.5%"
          class="hvr-underline-reveal d-table-cell {{activeBlockName ==='SKIPPED_TOO_SMALL' ? 'alert-secondary' : ''}}"
          (click)="setActiveBlockName('SKIPPED_TOO_SMALL')">
          {{blocks.SKIPPED_TOO_SMALL.label}}
          <h2>{{blocks.SKIPPED_TOO_SMALL.rows.length}}</h2>
        </td>
        <td style="width: 12.5%"
          class="hvr-underline-reveal d-table-cell {{activeBlockName ==='SKIPPED_0' ? 'alert-secondary' : ''}}"
          (click)="setActiveBlockName('SKIPPED_0')">
          {{blocks.SKIPPED_0.label}}
          <h2>{{blocks.SKIPPED_0.rows.length}}</h2>
        </td>
        <td style="width: 12.5%"
          class="hvr-underline-reveal d-table-cell {{activeBlockName ==='SKIPPED_MANUAL' ? 'alert-secondary' : ''}}"
          (click)="setActiveBlockName('SKIPPED_MANUAL')">
          {{blocks.SKIPPED_MANUAL.label}}
          <h2>{{blocks.SKIPPED_MANUAL.rows.length}}</h2>
        </td>
        <td class="hvr-underline-reveal d-table-cell {{activeBlockName ==='SKIPPED_ERROR' ? 'alert-secondary' : ''}}"
          (click)="setActiveBlockName('SKIPPED_ERROR')">
          {{blocks.SKIPPED_ERROR.label}}
          <h2 class="text-danger">{{blocks.SKIPPED_ERROR.rows.length}}</h2>

        </td>
      <tr>
    </tbody>
  </table>

  <div class="alert alert-info">
    <button class="btn btn-primary" (click)="processAll()" *ngIf="isLastCycle">
      <i class="fas fa-sync"></i> {{processing? 'STOP PROCESSING' : 'START PROCESSING'}}</button>
    <div *ngFor="let message of processingMessages">
      {{message}}
    </div>
  </div>
  <div *ngIf="activeBlock">
    <h2 class="text-center">
      {{activeBlock.label}}
    </h2>
    <div class="text-center">
      total (including canceled): {{total | currency:'USD':'symbol' }}
    </div>
    <div class="text-center">
      non-canceled: {{nonCanceledTotal | currency:'USD':'symbol' }}
    </div>
    <div class="text-center">
      sent total: {{sentTotal | currency:'USD':'symbol' }}
    </div>
    <div class="text-center">
      paid total: {{paidTotal | currency:'USD':'symbol' }}
    </div>
    <div class="text-right mb-2">
      <select [(ngModel)]="paymentFrequencyFilter" (change)="filter()">
        <option>select usage frequency...</option>
        <option>One Time</option>
        <option>No Restriction</option>
      </select>

      <select [(ngModel)]="paymentMeansFilter" (change)="filter()">
        <option>select payment means...</option>
        <option>MISSING</option>
        <option>MULTIPLE</option>
        <option>Direct Deposit</option>
        <option>Check Deposit</option>
        <option>Stripe</option>
        <option>Quickbooks Bank Withdraw</option>
        <option>Credit Card</option>
        <option>Check</option>
      </select>

    </div>

    {{paymentFrequencyFilter}} {{paymentMeansFilter}}
    <table class="table">
      <thead>
        <tr>
          <th>#</th>
          <th>Id</th>
          <th><button (click)="sort('name')" class="btn btn-link p-0">Name</button></th>
          <th>Invoice</th>
          <th>Sent</th>
          <th>Paid</th>
          <th>Payment Means</th>
          <th><button (click)="sort('balance')" class="btn btn-link p-0">Balance</button></th>
          <th>Error</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let row of activeBlock.rows; let i = index">
          <tr *ngIf="isRowVisible(row)" class="{{disabledSet.has(row._id) ? 'disabled' : ''}}">
            <td>{{i + 1}}</td>
            <td>{{(row._id || '').slice(-5)}}</td>
            <td><a routerLink="/restaurants/{{row._id}}" target="_blank">{{row.name}}</a></td>
            <td><a routerLink="/invoices/{{row.invoice?._id}}" target="_blank">{{row.invoice?._id}}</a></td>
            <td>
              <span *ngIf="row.invoice?.isSent" class="text-success"><strong>✓</strong></span>
              <span *ngIf="!row.invoice?.isSent" class="text-danger">&times;</span>
            </td>
            <td>
              <span *ngIf="row.invoice?.isPaymentSent" class="text-success"><strong>✓</strong></span>
              <span *ngIf="!row.invoice?.isPaymentSent" class="text-danger">&times;</span>
            </td>
            <td>
              {{getPaymentMeans(row).text}}
            </td>
            <td><span *ngIf="row.invoice?.balance">{{row.invoice?.balance | currency:'USD':'symbol'}}</span></td>
            <td class="text-danger">
              <div *ngIf="isLastCycle">
                <button (click)="sendOne(row)" [qLoading]="sending"
                  *ngIf="row.invoice && !row.invoice?.isSent">Send</button>
                <button (click)="payOne(row)" [qLoading]="paying"
                  *ngIf="row.invoice && !row.invoice?.isPaymentSent">Pay</button>
              </div>
              {{row.error | json}}
            </td>
          </tr>
        </ng-container>

      </tbody>
    </table>
  </div>


</div>