<h1 class="text-center">My Leads</h1>

<div class="card text-center">
  <div class="card-header">
    <ul class="nav nav-tabs card-header-tabs">
      <li class="nav-item" *ngFor="let tab of tabs">
        <a class="nav-link {{activeTab === tab? 'active' : ''}}" (click)="activeTab = tab">{{tab}} ({{getLeadsForTab(tab).length}})</a>
      </li>
    </ul>
  </div>
  <div class="card-body">
    <div class="table-responsive text-left">
      <table class="table table-hover">
        <thead>
          <tr>
            <th class="border-0"></th>
            <th class="border-0">Name</th>
            <th class="border-0">GMB</th>
            <th class="border-0">City</th>
            <th class="border-0">Zip Code</th>
            <th class="border-0">State</th>
            <th class="border-0">Timezone</th>
            <!-- <th class="border-0"></th> -->
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let lead of getLeadsForTab(activeTab)" class="{{lead.disabled || lead.closed ? 'text-muted closed' : ''}}" (click)="selectLead(lead)">
            <td class="text-success">
              ■
            </td>
            <th scope="row">
              <span class="{{lead.gmbScanned ? 'text-info': ''}}">{{lead.name}}
                <span class="text-muted" *ngIf="lead.oldName">
                  <br>
                  <small>{{lead.oldName}}</small>
                </span>
              </span>
              <button class="btn btn-link py-0" *ngIf="!lead.gmbScanned" (click)="scanLead(lead)" [disabled]="leadsInProgress.indexOf(lead) >= 0">
                <i class="fas fa-sync {{leadsInProgress.indexOf(lead) >= 0? 'fa-spin' : ''}}"></i>
              </button>

            </th>
            <td class="text-nowrap">
              <i class="fas fa-lock-open text-info" *ngIf="lead.gmbOpen"></i>
              <i class="fas fa-globe text-muted" *ngIf="!lead.gmbWebsite && lead.serviceProviders && lead.serviceProviders.length > 0"></i>
              {{lead.gmbOwner}}
            </td>
            <td>{{lead.address.locality}}</td>
            <td>{{lead.address.postal_code}}</td>
            <td>{{lead.address.administrative_area_level_1}}</td>
            <td>{{lead.address.timezone}}</td>
            <!-- <td>
              <button class="btn btn-link py-0" (click)="edit(lead)">
                <i class="fas fa-edit"></i> Edit
              </button>
            </td> -->
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<q-modal [title]="selectedLead.name" #leadModal>
  <app-lead-info [lead]="selectedLead"></app-lead-info>
  <hr>
  <h5 class="text-center">Call Logs</h5>
  <div class="pb-2">
    <button class="btn btn-primary" (click)="toggleNewCallLog()">
      <i class="fas fa-phone"></i> Add New Log</button>
  </div>

  <div class="card" *qIf="editingCallLog">
    <div class="card-body">
      <h5 class="card-title">New Call Log</h5>
      <app-call-logger [lead]="selectedLead" [callLog]="selectedCallLog" (cancel)="editingCallLog = false" (submit)="sumbitCallLog($event)"></app-call-logger>
    </div>

  </div>

  <div class="table-responsive text-left" *ngIf="selectedLead.callLogs && selectedLead.callLogs.length > 0">
    <table class="table table-hover">
      <thead>
        <tr>
          <th class="border-0">Result</th>
          <th class="border-0">Date</th>
          <th class="border-0">Number</th>
          <th class="border-0 text-center">Line</th>
          <th class="border-0">Callees</th>

          <th class="border-0">Comments</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let log of getSortedCallLogs()" (click)="selectCallLog(log)">
          <td>
            <span *ngIf="log.salesOutcome==='rejected'" class="text-danger">■</span>
            <span *ngIf="log.salesOutcome==='interested'" class="text-warning">■</span>
            <span *ngIf="log.salesOutcome==='success' || log.salesOutcome==='qmenuCustomer'" class="text-success">■</span>
            <span *ngIf="log.askedMoreInfo" class="text-info">■</span>
            <span *ngIf="log.callbackTime" class="text-info">
              <i class="fas fa-history"></i>
            </span>
          </td>
          <td>
            <small>{{log.time | date:'short'}}</small>
          </td>
          <td>*{{(log.phone || '').substring(6)}}</td>
          <td *ngIf="log.lineStatus === 'connected'" class="text-center">
            <i class="fas fa-check text-success"></i>
          </td>
          <td *ngIf="log.lineStatus === 'busy'" class="text-center">
            <i class="fas fa-exclamation text-warning"></i>
          </td>
          <td *ngIf="log.lineStatus === 'voicemail'" class="text-center">
            <i class="fas fa-cloud-upload-alt"></i>
          </td>
          <td>{{log.callees}}</td>

          <td>{{log.comments}}
            <span *ngIf="log.callbackTime" class="text-info">
              <i class="fas fa-history"></i> {{log.callbackTime}}
            </span>
          </td>
        </tr>
      </tbody>
    </table>
    <span class="legend text-danger">■=Rejected</span>
    <span class="legend text-info">■=Asked More Info </span>
    <span class="legend text-warning">■=Interested</span>
    <span class="legend text-success">■=Success</span>
    <br>
    <span class="legend text-warning">
      <i class="fas fa-exclamation"></i>=Busy</span>
    <span class="legend">
      <i class="fas fa-cloud-upload-alt"></i>=Voicemail</span>
    <span class="legend text-success">
      <i class="fas fa-check"></i>=Connected</span>
    <span class="text-info">
      <i class="fas fa-history"></i> Callback</span>
  </div>
  {{selectedLead | json}}
</q-modal>