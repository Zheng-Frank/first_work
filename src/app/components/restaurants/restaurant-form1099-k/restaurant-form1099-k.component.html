<div>
  <h2>View IRS Form 1099-K for {{restaurant.name}}</h2>
  <button class="btn btn-link"
    (click)="showExplanation = !showExplanation">{{!showExplanation ? 'Show Explanation' : 'Hide Explanation'}}</button>
  <p *ngIf="showExplanation">
    Two copies of Form 1099-K will be generated for a restaurant for each year that the form is needed, in January of
    the following year. We must provide the restaurant with one copy for them to submit to the IRS, as well as submit
    another copy to the IRS on their behalf. For tax years 2020 and 2021, Qmenu must have collected at least $20,000 and
    processed at least 200 transactions for a restaurant to necessitate Form 1099-K for that year. For tax year 2022
    onward, Qmenu must have collected $600 or more for a restaurant to necessitate a Form 1099-K.
  </p>
  <hr>
  <!-- start with Payee/TIN/Email Attributes -->
  <div class="row ml-2 form-inline">
    <div>
      <b>TIN: </b>
      <b class="text-danger" *ngIf="!restaurant.tin">Attribute Missing</b>
      <q-edit-label [value]="restaurant.tin" (edit)="onEdit($event, 'rtTIN')">
      </q-edit-label>
    </div>
    <div class="mx-2">
      <b>Payee: </b>
      <b class="text-danger" *ngIf="!restaurant.payeeName">Attribute Missing</b>
      <q-edit-label [value]="restaurant.payeeName" (edit)="onEdit($event, 'payeeName')">
      </q-edit-label>
    </div>
    <div class="mx-2">
      <b>Email: </b>
      <span *ngIf="emails.length > 0; else elseBlockEmail">{{emails.join(', ')}} </span>
      <ng-template #elseBlockEmail>
        <b class="text-danger">Attribute Missing</b>
        <q-edit-label [emptyHint]="'(click to add)'" [value]="" [type]="'text'" (edit)="onEdit($event, 'Email')">
        </q-edit-label>
      </ng-template>
    </div>
    <div class="mx-2">
      <b>Tin Type: </b>
      <b class="text-danger" *ngIf="!restaurant.tinType">Attribute Missing</b>
      <span>{{restaurant.tinType}}</span>
      <a class="btn-link ml-2" (click)="openTinTypeModal()">Edit</a>
    </div>
    <!-- start with tax year filter -->
    <select class="form-control mx-2" [(ngModel)]="taxYear">
      <option value="" disabled selectedtml> Choose an option... </option>
      <option *ngFor="let entry of taxYearOptions"> {{entry}} </option>
    </select>
    <!-- end with tax year filter -->
    <!-- start with customized btn -->
    <a class="btn-link" (click)="openCustomize1099kModal()" *ngIf="taxYear">
      {{hasCustomOfThisYear(restaurant.form1099k || []) ? 'Edit Customizations' : 'Customize'}}
    </a>
    <!-- end with customized btn -->
  </div>
  <!-- end with Payee/TIN/Email Attributes -->
  <p><br> Please be patient. Downloading may take some time. </p>
  <!-- start with 1099k form list -->
  <ul>
    <ng-container *ngFor="let linkEntry of formLinks">
      <li *ngIf="linkEntry[0]; else elseBlock" class="py-2">
        <ng-container *ngIf="linkEntry[0].required; else requiredBlock">
          {{linkEntry[1]}} <span *ngIf="linkEntry[0].yearPeriodStart">(Customized Part
            {{getCustomizedNum(linkEntry[0])}})</span> -
          <ng-container *ngIf="allAttributesPresent(); else missingAttributesBlock">
            <a class="btn-link" (click)="renderPDFForm('qmenu',linkEntry)"> for qMenu
              <i class="fa fa-download"></i></a>
            <a class="btn-link ml-2" (click)="renderPDFForm('restaurant',linkEntry)"> for Restaurant
              <i class="fa fa-download"></i></a>
            <a class="btn-link ml-2" (click)="openSendEmailModal(linkEntry)">Send</a>
            <span *ngIf="linkEntry[0].sent" class="text-success">
              (Sent)
            </span>
          </ng-container>
          <ng-template #missingAttributesBlock>
            <span class="text-danger">
              Fill in all missing attributes to enable file download.
            </span>
          </ng-template>
        </ng-container>
        <ng-template #requiredBlock>
          {{linkEntry[1]}} <span *ngIf="linkEntry[0].yearPeriodStart">(Customized Part
            {{getCustomizedNum(linkEntry[0])}})</span> - No Form Required for this year
        </ng-template>
      </li>
      <ng-template #elseBlock>
        <li>
          <a class="btn-link disabled" *ngIf="disbleCalBtn(linkEntry)">Calculate 1099K</a>
          <a class="btn-link"  *ngIf="!disbleCalBtn(linkEntry)" (click)="calculateForm1099k(linkEntry)">Calculate
            1099K</a>
        </li>
      </ng-template>
    </ng-container>
  </ul>
  <!-- end with 1099k form list -->
  <!-- start with send emails modal -->
  <q-modal #sendEmailModal [size]="'lg'">
    <button type="button" class="close" (click)="sendEmailModal.hide()">
      <span>×</span>
    </button>
    <h4 class="text-center">Send PDF Form</h4>
    <hr>
    <!-- start with email channels -->
    <div *ngIf="allEmails.length > 0">
      <div *ngFor="let email of allEmails">
        <input type="checkbox" (change)="selectTarget($event, email)" [value]="email.value"
          [checked]="targets.includes(email)">
        <i class="fas fa-envelope-square"></i>
        {{email.value}}
        <ng-container *ngIf="email.notifications?.length">({{email.notifications?.join("/")}})</ng-container>
      </div>
    </div>
    <div *ngIf="allEmails.length <= 0">
      No message target found, please add the contact you need to the RT's contacts.
    </div>
    <!-- end with email channels -->
    <!-- template has some input varible to fill in -->
    <div *ngIf="template">
      <div class="mt-2" *ngFor="let field of template.inputs">
        <label>{{field.label}}<span class="text-danger">*</span></label>
        <input class="form-control" type="{{field.type || 'text'}}" [(ngModel)]="field.value">
      </div>
      <div class="msg-content mt-2" [innerHTML]="sanitized(template.html)"></div>
    </div>
    <!--start with mark only checkbox-->
    <div class="mt-3">
      <input type="checkbox" [(ngModel)]="markSentFlag"> Only Mark as Sent
      <i class="fa fa-info-circle" data-toggle="tooltip" data-placement="top" title="If you've already sent the 1099K form(s) to the restaurant outside of this tool,
         you can mark the status as 'Sent' by checking this box and clicking 'Send', and it'll update the status to 'Sent' without actually sending the form(s) again.
        (如果您已经将1099K表格发送到该工具之外的餐厅，您可以通过选中此框并单击“发送”将状态标记为“已发送”，它会将状态更新为“已发送”，而不会再次实际发送表格。)"></i>
    </div>
    <!-- end with mark only checkbox -->
    <div class="d-flex justify-content-end p-4">
      <button class="btn btn-secondary mr-2" (click)="sendEmailModal.hide()">Cancel</button>
      <button class="btn btn-primary" (click)="sendPDFFormToRT()" [qLoading]="sendLoading">Send</button>
    </div>
  </q-modal>
  <!-- end with send email modal -->
  <!-- start with tin type modal -->
  <q-modal #tinTypeModal>
    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
      <span aria-hidden="true">×</span>
    </button>
    <h4 class="text-center">Tin Type</h4>
    <hr>
    <div class="row my-3">
      <select class="form-control mx-2" [(ngModel)]="tinType">
        <option *ngFor="let type of tinTypes"> {{type}} </option>
      </select>
    </div>
    <div class="d-flex justify-content-end p-4">
      <button class="btn btn-secondary mr-2" (click)="tinTypeModal.hide()">Cancel</button>
      <button class="btn btn-primary" (click)="patchTinType()">Submit</button>
    </div>
  </q-modal>
  <!-- end with tin type modal -->
  <!-- start with customize 1099k modal -->
  <q-modal #customize1099kModal [size]="'600px'">
    <button type="button" class="close" (click)="closeCustomize1099kModal()">
      <span aria-hidden="true">×</span>
    </button>
    <h4 class="text-center">Customize 1099k</h4>
    <hr>
    <div class="container">
      <div class="my-3" *ngFor="let item of customize1099kList;let i = index;">
        <div>
          <div class="row">
            <label>Tax Year {{taxYear}} (Part {{i+1}})</label>
            <a class="btn-link close-btn-pos" *ngIf="i > 0" (click)="deleteCustomNewLine(i)">
              <i class="fa fa-times"></i>
            </a>
          </div>
          <div class="row form-inline">
            <input class="form-control" (change)="changeCustomItem(item)" type="text" [(ngModel)]="item.tin"
              placeholder="Period TIN">
            <select class="form-control ml-2 custom-tintype-width" [(ngModel)]="item.tinType"
              (change)="changeCustomItem(item)">
              <option *ngFor="let type of customizeTinTypes"> {{type}} </option>
            </select>
          </div>
          <div class="row">
            <input class="form-control mt-2" type="text" (change)="changeCustomItem(item)" [(ngModel)]="item.payeeName"
              placeholder="Period Payee Name">
          </div>
        </div>
        <div class="row form-inline mt-2">
          <label>From:</label>
          <input class="form-control ml-1" type="date" (change)="changeCustomItem(item)" [(ngModel)]="item.fromDate">
          <label class="ml-2">To:</label>
          <input class="form-control ml-1" type="date" (change)="changeCustomItem(item)" [(ngModel)]="item.toDate">
          <button class="btn btn-primary ml-2" [disabled]="hasCustomItemErr(i)"
            (click)="calcTransactionByTime(item.fromDate, item.toDate, item)">
            <i class="fa fa-calculator"></i>
            Calculate
          </button>
        </div>
        <div class="row text-muted" *ngIf="item.rt1099KData">
          {{item.transactionText}}
        </div>
        <div class="row" *ngIf="hasCustomItemErr(item)">
          <span class="text-danger">{{hasCustomItemErr(i)}}</span>
        </div>
        <hr *ngIf="i < customize1099kList.length - 1" />
      </div>
      <div class="row">
        <button class="btn btn-primary" (click)="addCustomNewLine()" *ngIf="customize1099kList.length >= 1"><i
            class="fa fa-plus"></i>
          Add new portion
        </button>
      </div>
    </div>
    <div class="d-flex justify-content-end p-4">
      <button class="btn btn-secondary mr-2" (click)="closeCustomize1099kModal()">Cancel</button>
      <button class="btn btn-primary" (click)="patchCustom1099k()" [disabled]="hasCustomize1099kError()">Submit</button>
    </div>
  </q-modal>
  <!-- end with custom 1099k modal -->
</div>
