<div class="text-center">
  <h3>List of Restaurants with QR Dine-In ({{qrFilterRestaurantListRows?.length || 0}})</h3>
</div>
<div class="row">
  <div class="pb-2 text-left col-12">
    <div class="float-left form-inline ml-2 mr-2">
      <label class="form-check-label mr-2">Show</label>
      <select [(ngModel)]="filterType" class="form-control ml-1" (change)="filter()">
        <option *ngFor="let type of filterTypes" [value]="type">{{type}}</option>
      </select>
    </div>
    <div class="float-left form-inline ml-2 mr-2">
      <label class="form-check-label mr-2">QR Salesperson</label>
      <select [(ngModel)]="qrSalesperson" class="form-control ml-1" (change)="filter()">
        <option value="All">All</option>
        <ng-container *ngFor="let person of qrSalespeople">
          <option *ngIf="person != 'None'" [value]="person">{{person}}</option>
        </ng-container>
        <option value="None">None</option>
      </select>
    </div>
    <div class="float-left form-inline ml-2 mr-2 mt-2">
      <input class="form-check-input" type="checkbox" [(ngModel)]="showAllLogs">
      <label class="form-check-label" for="id-gmb"> Show all logs</label>
    </div>
    <div class="float-left form-inline ml-2 mr-2 mt-2">
      <input class="form-check-input" type="checkbox" [(ngModel)]="hideMore20OrdersFlag" (change)='filter()'>
      <label class="form-check-label" for="id-gmb"> Hide RTs with >20 orders</label>
    </div>
    <div class="float-left form-inline ml-2 mr-2">
      <button class="btn btn-primary" (click)="showQRSettingsFilters()">Filters</button>
      <span class="ml-2"> {{qrSettingFilterText}}</span>
    </div>
  </div>
  <div class="col-12 pl-4">
    <button class="btn btn-primary" (click)="reload()"><i class="fas fa-sync"></i> Reload</button>
  </div>
</div>

<div class="card-body text-left">
  <div *ngIf="!qrRestaurantListRows || qrRestaurantListRows.length === 0">
    Qr Restaurant list is empty.
  </div>
  <q-table [rows]="qrFilterRestaurantListRows" [tableColumnDescriptors]="restaurantsColumnDescriptors" [compact]="true"
    [pageSize]="100000">
    <tr *tableRowTemplate="let restaurant;">
      <td>{{qrFilterRestaurantListRows.indexOf(restaurant) + 1}}</td>
      <td>
        <a href="#/restaurants/{{restaurant._id}}" target="_blank">{{restaurant.name}}</a>
        <br>
        {{restaurant.googleAddress?.formatted_address}}
        <br>
        <br>
        <div>
          QR Salesperson: {{restaurant?.qrSettings?.agent}}
        </div>
        <br>
        <div *ngFor="let menu of restaurant.menus">
          {{menu.name}} ({{menu.menuTarget || 'Online only'}})
        </div>
      </td>
      <td>
        {{restaurant.qrOrderNumber}}
      </td>
      <td>
        <button class="btn btn-link py-0"
          (click)="restaurant === restaurantShowingDetails ? restaurantShowingDetails = null : restaurantShowingDetails = restaurant">{{restaurant.qrScans}}</button>
        <div *ngIf="restaurant === restaurantShowingDetails">
          <div *ngFor="let evt of getAnalyticsEvents(restaurant)" class="text-nowrap">
            {{evt.createdAt | adjustedDate : 'MMM d h:mm a' : restaurant.googleAddress.timezone}}
            {{evt.runtime.os}}
            {{evt.runtime.browser}}
          </div>
        </div>
      </td>
      <td>
        {{restaurant.lastKnownAliveTime | adjustedDate : 'MMM d h:mm a' : restaurant.googleAddress.timezone}}
      </td>
      <td>
        <div *ngFor="let r of restaurant.Reasons">
          {{r}}
        </div>
        <div *ngIf="isSchedulesValid(restaurant)">
          <button class="btn btn-link" (click)="openSchedulesModal(restaurant)">Fix Fee/Rate Schedules</button>
        </div>
        <div class="row">
          <div class="col-12">
            <div class="ml-2 mt-2">
              <input class="form-check-input" type="checkbox" [checked]="restaurant.qrSettings.hasSignHoldersAt"
                (change)="addQRSettingFilters(restaurant,'hasSignHoldersAt')">
              <label class="form-check-label"> Sign holders purchased</label>
            </div>
            <div class="ml-2 mt-2">
              <input class="form-check-input" type="checkbox" [checked]="restaurant.qrSettings.hasQRTrainingAt"
                (change)="addQRSettingFilters(restaurant,'hasQRTrainingAt')">
              <label class="form-check-label"> RT is trained</label>
            </div>
            <div class="ml-2 mt-2">
              <input class="form-check-input" type="checkbox" [checked]="restaurant.qrSettings.qrCodesMailedAt"
                (change)="addQRSettingFilters(restaurant,'qrCodesMailedAt')">
              <label class="form-check-label"> QR codes mailed</label>
            </div>
            <div class="ml-2 mt-2">
              <input class="form-check-input" type="checkbox" [checked]="restaurant.qrSettings.qrCodesObtainedAt"
                (change)="addQRSettingFilters(restaurant,'qrCodesObtainedAt')">
              <label class="form-check-label"> QR codes received</label>
            </div>
          </div>
        </div>
      </td>
      <td>
        {{restaurant.qrSettings.createdAt | adjustedDate : 'MMM d h:mm a' : restaurant.googleAddress.timezone}}
      </td>
      <td>
        <ng-container *ngIf="!showAllLogs">
          <table class="table table-sm">
            <tr>
              <th>Number</th>
              <th>User</th>
              <th>Timer</th>
              <th>Problem</th>
              <th>Response</th>
            </tr>
            <ng-container *ngFor="let log of restaurant.logs">
              <tr *ngIf="log.type === 'qr-dine-in'">
                <td>{{restaurant.logs.indexOf(log)+1}}</td>
                <td>{{log.username}}</td>
                <td>{{log.time | adjustedDate : 'MMM d h:mm a' : restaurant.googleAddress.timezone}}</td>
                <td>{{log.prblem}}</td>
                <td>{{log.response}}</td>
              </tr>
            </ng-container>
          </table>
          <div>
            <button class="btn btn-primary" (click)="addLog(restaurant)"><i class="fas fa-plus"></i>Add Log</button>
          </div>
        </ng-container>
        <ng-container *ngIf="showAllLogs">
          <table class="table table-sm">
            <tr>
              <th>Number</th>
              <th>User</th>
              <th>Timer</th>
              <th>Problem</th>
              <th>Response</th>
            </tr>
            <tr *ngFor="let log of restaurant.logs">
              <td>{{restaurant.logs.indexOf(log)+1}}</td>
              <td>{{log.username}}</td>
              <td>{{log.time | adjustedDate : 'MMM d h:mm a' : restaurant.googleAddress.timezone}}</td>
              <td>{{log.prblem}}</td>
              <td>{{log.response}}</td>
            </tr>
          </table>
          <div>
            <button class="btn btn-primary" (click)="addLog(restaurant)"><i class="fas fa-plus"></i>Add Log</button>
          </div>
        </ng-container>
      </td>
    </tr>
  </q-table>
  <!-- start with schedule modal -->
  <q-modal #schedulesModal>
    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
      <span aria-hidden="true">×</span>
    </button>
    <h4 class="text-center">Fix Fee/Rate Schedules</h4>
    <hr>
    <div *ngIf="schedulesRestaurant && schedulesRestaurant.feeSchedules">
      <app-restaurant-fee-schedules [restaurant]="schedulesRestaurant" [users]="knownUsers">
      </app-restaurant-fee-schedules>
    </div>
    <div *ngIf="schedulesRestaurant && !schedulesRestaurant.feeSchedules">
      <app-restaurant-rate-schedules [restaurant]="schedulesRestaurant" [users]="knownUsers">
      </app-restaurant-rate-schedules>
    </div>
  </q-modal>
  <!-- end with schedule modal -->
  <!-- start with the log editing modal-->
  <q-modal #logEditingModal>
    <app-log-editor #myLogEditor [restaurant]="restaurant" [restaurantList]="[]" [log]="logInEditing"
      (success)="onSuccessAddLog($event)" (cancel)="onCancelAddLog()" (remove)="removeLog($event)"></app-log-editor>
  </q-modal>
  <!-- end with the log editing modal -->
  <!-- start with qrsettings filters condition modal -->
  <q-modal #QRSettingsFiltersModal>
    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
      <span aria-hidden="true">×</span>
    </button>
    <h4 class="text-center">Filters</h4>
    <hr>
    <div class="container">
      <div class="row mb-3 ml-5">
        <div class="col-12">
          <div class="ml-2 mt-2">
            <input class="form-check-input" type="checkbox" [(ngModel)]="hasSignHolders">
            <label class="form-check-label"> Sign holders purchased</label>
          </div>
          <div class="ml-2 mt-2">
            <input class="form-check-input" type="checkbox" [(ngModel)]="hasQRTraining">
            <label class="form-check-label"> RT is trained</label>
          </div>
          <div class="ml-2 mt-2">
            <input class="form-check-input" type="checkbox" [(ngModel)]="qrCodesMailed">
            <label class="form-check-label"> QR codes mailed</label>
          </div>
          <div class="ml-2 mt-2">
            <input class="form-check-input" type="checkbox" [(ngModel)]="qrCodesObtained">
            <label class="form-check-label"> QR codes received</label>
          </div>
        </div>
      </div>
    </div>
    <div class="d-flex justify-content-end p-4">
      <button class="btn btn-secondary mr-2" (click)="cancelQRSettingsFilter()">Cancel</button>
      <button class="btn btn-primary" (click)="filter()">OK</button>
    </div>
  </q-modal>
  <!-- end with qrsettings filters condition modal -->
</div>
