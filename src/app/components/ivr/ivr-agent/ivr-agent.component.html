<div class="pt-2">
  <h1 class="text-center">IVR Logs ({{filteredIvrRecords.length || 0}})</h1>
  <div class="my-text-small text-muted text-center" *ngIf="needRefreshCtrs">
    refreshed: {{ lastRefreshed | ago: now }} | total:
    {{ totalMinutes }} minutes
  </div>

  <div class="my-text-small text-muted text-center">
    {{ ivrUsername || "NOT LOGGED IN" }} |
    <span *ngFor="let phone of getMyPhones()">{{ phone | tel }} | </span>
    {{ getVisibleQueueNames().join(", ") }}
  </div>

  <div class="form-inline">
    <!-- start with filter condition -->
    <label *ngIf="isAdmin()">Admin view<q-toggle class="mr-2 ml-1 mt-2" [(ngModel)]="adminViewMode"
        (change)="reloadIVRByManagerRoles()"></q-toggle></label>
    <input [qDebounce]="500" (debounce)="filter($event)" type="text" class="form-control mr-2 mt-2"
      placeholder="phone or restaurant ID" [(ngModel)]="searchFilter" />
    <!-- start with IVR roles filter -->
    <select (change)="reloadIVRByManagerRoles()" *ngIf="adminViewMode" [(ngModel)]="managerRole"
      class="form-control mr-2 mt-2">
      <option *ngFor="let mr of managerRoles" [ngValue]="mr">
        {{ mr }}
      </option>
    </select>
    <!-- end with IVR roles filter -->
    <select (change)="filterQueue()" [(ngModel)]="selectedQueue" class="form-control mr-2 mt-2">
      <option *ngFor="let q of queuesForFilter" [ngValue]="q">
        {{ q.name || (q.arn ? "(no name))" : "(no arn)") }}
      </option>
    </select>
    <select (change)="filterQueue()" [(ngModel)]="selectedAgent" class="form-control mr-4 mt-2">
      <option *ngFor="let agent of agentsForFilter" [ngValue]="agent">
        {{ agent || "(no agent)" }}
      </option>
    </select>
    <select (change)="filterQueue()" [(ngModel)]="selectedLanguageCode" class="form-control mr-2 mt-2">
      <option *ngFor="let languageCode of languageCodesForFilter" [ngValue]="languageCode">
        {{ languageCode || "(N/A)" }}
      </option>
    </select>
    <label class="checkbox-inline mt-2"><input type="checkbox" [(ngModel)]="shouldCallbackOnly" (change)="filter()"
        class="mx-1" />
      Should callback</label>
    <!-- end with filter condition -->
    <!-- start with refresh button -->
    <div class="form-inline refresh-btn">
      <label class="checkbox-inline mt-2" for="id-gmb" *ngIf="!showDateSearch"><input type="checkbox" 
        class="mx-1"  [(ngModel)]="needRefreshCtrs">
        Auto Refresh
      </label>
      <button class="btn btn-primary ml-2 mt-2" *ngIf="!showDateSearch && !adminViewMode" (click)="startIvr()">
        <i class="fas fa-headset"></i> qMenu IVR
      </button>
      <button class="btn btn-primary ml-2 mt-2" *ngIf="!showDateSearch" (click)="refreshCtrs()" [qLoading]="refreshing">
        <i class="fas fa-sync-alt"></i> Reload
      </button>
    </div>
    <!-- end with refresh button -->
  </div>
  <!-- start with date search -->
  <div class="row form-group mt-2">
    <button type="button" class="btn btn-link ml-2" (click)="toggleShowDateSearch()">
      {{ showDateSearch?'Hide date search..':'Show date search..'}}</button>
    <div class="form-inline ml-2" *ngIf="showDateSearch">
      <label>From:</label>
      <input class="form-control ml-1" type="date" [(ngModel)]="fromDate">
      <button class="btn btn-primary ml-2" (click)="refreshCtrs()"><i class="fa fa-search"></i>
        Search</button>
    </div>
  </div>
  <!-- end with date search -->

  <table class="table mt-2">
    <tr>
      <th>#</th>
      <th>Time</th>
      <th>Phone#</th>
      <th>Restaurant</th>
      <th>Queue</th>
      <th>Agent</th>
      <th>Recording</th>
      <th>Status</th>
    </tr>
    <tr *ngFor="let ir of filteredIvrRecords; let i = index" class="{{ ir.shouldCallback ? 'alert-danger' : '' }}">
      <th>{{ i + 1 }}</th>
      <td style="width:10%;">
        {{ ir.initiatedAt | adjustedDate : 'MM/dd/yy h:mm a' : 'America/New_York'}}<br />
        <label>{{ ir.initiatedAt | ago: now }} (Duration: {{ir.duration ? ir.duration + "s" : "-"}})</label>
      </td>
      <td class="text-nowrap">
        <strong>{{ ir.customerEndpoint | tel }}</strong>
        <i *ngIf="!ir.inbound" class="fas fa-external-link-alt"></i>
        <div class="my-text-small text-muted">{{ ir.ctrId }}</div>
      </td>
      <td class="text-nowrap">
        <div *ngFor="let rt of ir.restaurants" class="pb-1">
          <a routerLink="/restaurants/{{ rt._id }}" target="_blank">{{
            rt.name
          }}</a>
          <div class="my-text-small text-muted">
            {{ rt._id }}
          </div>
        </div>
      </td>
      <td>
        {{ (ir.queueName || "").replace("chinese", "中文") }}
        <div class="my-text-small">
          <strong>{{ ir.languageCode }}</strong>
        </div>
      </td>
      <td>
        {{ ir.agentUsername }}
        <div class="my-text-small text-muted">
          {{ ir.systemEndpoint | tel }}
        </div>
      </td>
      <td>
        <audio controls *ngIf="ir.recordingMp3Url" preload="none">
          <source src="{{ ir.recordingMp3Url }}" />
        </audio>
        <div class="my-text-small" *ngIf="ir.transcriptFull">
          {{ ir.transcriptFull }}
        </div>
      </td>
      <td>
        <div *ngIf="ir.shouldCallback">SHOULD CALLBACK</div>
      </td>
    </tr>
  </table>
</div>
