<h1 class="text-center">My Leads ({{ongoingTab.rows.length}})</h1>

<div class="text-right">
  <span *ngIf="isAdmin" class="pl-3">
    Impersonate:
    <select class="form-control w-auto d-inline-block ml-3" style="padding-top: 1px" [(ngModel)]="username"
      (change)="changeUser()">
      <option></option>
      <option *ngFor="let user of usernames">{{user}}</option>
    </select>
  </span>
  <button class="btn btn-primary" (click)="toggleAction('REPLENISH')">Replenish Leads (获取更多销售商家)</button>
  <button [disabled]="ongoingTab.rows.length === 0" class="btn btn-primary" (click)="toggleAction('RELEASE_UNTOUCHED')">Release Untouched (释放没动过的)</button>

</div>


<div class="mt-3" *qIf="action === 'RELEASE_UNTOUCHED'">
  <div class="alert alert-danger">
    将会释放所有没有动过的销售目标餐馆(THIS WILL REMOVE ALL UNTOUCHED LEADS FROM YOUR LIST). 
  </div>
  <div class="text-right">
    <button class="btn btn-link" (click)="action=null">Cancel</button>
    <button class="btn btn-primary" (click)="releaseUntouched()">Confirm</button>
  </div>
</div>

<div class="mt-3" *qIf="action === 'REPLENISH'">
  <ul class="list-group">
    <li class="list-group-item d-flex justify-content-between bg-light" *ngFor="let funnel of publishedFunnels">
      <div>
        <div class="funnel-name">{{funnel.name}}</div>
        <div class="my-text-small">
          {{funnel.description}}
        </div>
        <div class="my-text-small">
          {{funnel.getComments()}}
        </div>
        <div *ngIf="funnel.analysis">
          {{funnel.getAnalysisString()}}
        </div>
      </div>
      <button class="btn btn-primary h-fit" (click)="assign(funnel, TAKE_BATCH_SIZE)">Take {{TAKE_BATCH_SIZE}}
        (获取{{TAKE_BATCH_SIZE}}个)</button>
    </li>
  </ul>
  <div class="text-right">
    <button class="btn btn-link" (click)="action=null">Cancel</button>
  </div>
</div>

<!-- Tabs -->
<div class="card text-center my-3">
  <div class="card-header">
    <ul class="nav nav-tabs card-header-tabs">
      <li class="nav-item" *ngFor="let tab of tabs" style="cursor: pointer;">
        <a class="nav-link {{activeTab === tab? 'active' : ''}}"
          (click)="setActiveTab(tab)">{{tab.label}}({{tab.rows.length}})</a>
      </li>
    </ul>
  </div>

  <!-- Main Table Body -->
  <div class="card-body text-left">
    <q-table [rows]="activeTab.rows" [tableColumnDescriptors]="myColumnDescriptors" [compact]="true"
      [pageSize]="100000">
      <tr *tableRowTemplate="let row;">
        <td>
          <div *ngIf="row.lead.campaigns[0].scheduledAt" class="badge badge-{{getScheduledAtStatusClass(row.lead)}}">{{(row.lead.campaigns[0]?.scheduledAt|| 0) |
            ago: now}}</div>
        </td>
        <td>
          <div class="my-text-b text-info" role="button" (click)="showDetails(row.lead)">{{row.lead.name}}</div>
          <div>
            <a *ngIf="row.lead.googleListing?.place_id" class="my-text-small"
              href="https://www.google.com/search?q={{getQ(row.lead)}}" target="_blank">{{row.lead.address}},
              {{row.lead.city}}, {{row.lead.state}} {{row.lead.zipcode}} <i class="fas fa-external-link-alt"></i></a>
          </div>
          <div (click)="copyToClipboard(row.lead.phone)" style="cursor:pointer;">
            {{row.lead.phone | phone}} <span class="text-success" *ngIf="row.lead.phone === copiedText">✓ copied</span>
          </div>
        </td>
        <td>
          {{row.timezone}} {{translateTimezone(row.timezone)}}
          <div><small>{{row.localTime}}</small></div>
        </td>
        <td>
          {{row.lead.googleListing?.gmbOwner}}
        </td>
        <td>
          {{row.lead.campaigns[0]?.funnel?.name}}
        </td>
        <td class="my-text-tiny">
          <ng-container *ngFor="let campaign of row.lead.campaigns || []">
            <div *ngFor="let log of campaign.logs || []">
              <div class="log-outcome">
                <span *ngIf="log.salesOutcome==='rejected'" class="text-danger">■</span>
                <span *ngIf="log.salesOutcome==='interested'" class="text-warning">■</span>
                <span *ngIf="log.salesOutcome==='success' || log.salesOutcome==='qmenuCustomer'"
                  class="text-success">■</span>
              </div>
              <app-lead-call-log [callLog]="log"></app-lead-call-log>
            </div>
          </ng-container>
        </td>

        <td>
          <button class="btn btn-link" (click)="release(row.lead)">
            Release
          </button>
          <button class="btn btn-primary btn-sm" (click)="showDetails(row.lead)">
            Show More...
          </button>
        </td>
      </tr>
    </q-table>
  </div>
</div>

<q-modal #leadModal>
  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
    <span aria-hidden="true">×</span>
  </button>
  <app-lead-details [lead]="selectedLead"></app-lead-details>
</q-modal>