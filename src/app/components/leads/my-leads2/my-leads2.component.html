<h1 class="text-center">My Leads ({{ongoingTab.rows.length}})</h1>

<div class="text-right">
  <span *ngIf="isAdmin" class="pl-3">
    Impersonate:
    <select class="form-control w-auto d-inline-block ml-3" style="padding-top: 1px" [(ngModel)]="username"
      (change)="changeUser()">
      <option></option>
      <option [value]="user" *ngFor="let user of usernames">{{user}}</option>
    </select>
  </span>
  <button class="btn btn-primary" (click)="replenish()">Replenish Leads (获取更多销售商家)</button>
  <button [disabled]="ongoingTab.rows.length === 0" *ngIf="isAdmin" class="btn btn-primary" (click)="releaseReassignModal.show()">Release/Reassign (释放/分配)</button>
  <button [disabled]="ongoingTab.rows.length === 0" *ngIf="!isAdmin" class="btn btn-primary" (click)="action = 'RELEASE_UNTOUCHED'">Release (释放)</button>

</div>

<div class="mt-3" *qIf="replenishing">
  <ul class="list-group">
    <li class="list-group-item d-flex justify-content-between bg-light" *ngFor="let funnel of publishedFunnels">
      <div>
        <div class="funnel-name">{{funnel.name}}</div>
        <div class="my-text-small">
          {{funnel.description}}
        </div>
        <div class="my-text-small">
          {{funnel.getComments()}}
        </div>
        <div *ngIf="funnel.analysis">
          {{funnel.getAnalysisString()}}
        </div>
      </div>
      <button class="btn btn-primary h-fit" (click)="assign(funnel)">Take {{TAKE_BATCH_SIZE}}
        (获取{{TAKE_BATCH_SIZE}}个)</button>
    </li>
  </ul>
  <div class="text-right">
    <button class="btn btn-link" (click)="replenishing=false">Cancel</button>
  </div>
</div>

<div class="mt-3" *qIf="action === 'RELEASE_UNTOUCHED'">
  <div class="alert alert-danger">
    将会释放所有没有动过的销售目标餐馆(THIS WILL REMOVE ALL UNTOUCHED LEADS FROM YOUR LIST).
  </div>
  <div class="text-right">
    <button class="btn btn-link" (click)="action=null">Cancel</button>
    <button class="btn btn-primary" (click)="releaseUntouched()">Confirm</button>
  </div>
</div>

<!-- Tabs -->
<div class="card text-center my-3">
  <div class="card-header">
    <ul class="nav nav-tabs card-header-tabs">
      <li class="nav-item" *ngFor="let tab of tabs" style="cursor: pointer;">
        <a class="nav-link {{activeTab === tab? 'active' : ''}}"
          (click)="setActiveTab(tab)">{{tab.label}}({{tab.rows.length}})</a>
      </li>
    </ul>
  </div>

  <!-- Main Table Body -->
  <div class="card-body text-left">
    <div class="m-3">
      <label for="timezone_filter">Timezone:</label>
      <select id="timezone_filter" class="form-control w-auto d-inline-block ml-3" [(ngModel)]="activeTab.filter" (change)="fillTabs()">
        <option *ngFor="let tz of getTimezoneKeys()" [value]="tz">{{tz}} {{translateTimezone(tz)}}</option>
      </select>
    </div>
    <q-table [rows]="activeTab.rows" [tableColumnDescriptors]="myColumnDescriptors" [compact]="true"
      [pageSize]="100000">
      <tr *tableRowTemplate="let row;">
        <td>
          <div *ngIf="row.lead.campaigns[0].scheduledAt" class="badge badge-{{getScheduledAtStatusClass(row.lead)}}">{{(row.lead.campaigns[0]?.scheduledAt|| 0) |
            ago: now}}</div>
        </td>
        <td>
          <div class="my-text-b text-info" role="button" (click)="showDetails(row.lead)">{{row.lead.name}}</div>
          <div>
            <a *ngIf="row.lead.googleListing?.place_id" class="my-text-small"
              href="https://www.google.com/search?q={{getQ(row.lead)}}" target="_blank">{{row.lead.address}},
              {{row.lead.city}}, {{row.lead.state}} {{row.lead.zipcode}} <i class="fas fa-external-link-alt"></i></a>
          </div>
          <div (click)="copyToClipboard(row.lead.phone)" style="cursor:pointer;">
            {{row.lead.phone | phone}} <i class="fas fa-database"></i> <span class="text-success" *ngIf="row.lead.phone === copiedText">✓ copied</span>
          </div>
          <div *ngIf="row.lead.googleListing?.phone" (click)="copyToClipboard(row.lead.googleListing.phone)" style="cursor:pointer;">
            {{row.lead.googleListing.phone | phone}} <i class="fab fa-google"></i> <span class="text-success" *ngIf="row.lead.googleListing.phone === copiedText">✓ copied</span>
          </div>
          <div *ngIf="leadPhoneDifferentToGoogle(row)" class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>Biz phone listed on GMB different than our lead database!
          </div>
        </td>
        <td>
          {{row.timezone}} {{translateTimezone(row.timezone)}}
          <div><small>{{row.localTime}}</small></div>
        </td>
        <td>
          {{row.lead.googleListing?.gmbOwner}}
        </td>
        <td>
          {{row.lead.campaigns[0]?.funnel?.name}}
        </td>
        <td class="my-text-tiny">
          <ng-container *ngFor="let campaign of row.lead.campaigns || []">
            <div *ngFor="let log of campaign.logs || []">
              <div class="log-outcome">
                <span *ngIf="log.salesOutcome==='rejected'" class="text-danger">■</span>
                <span *ngIf="log.salesOutcome==='interested'" class="text-warning">■</span>
                <span *ngIf="log.salesOutcome==='success' || log.salesOutcome==='qmenuCustomer'"
                  class="text-success">■</span>
              </div>
              <app-lead-call-log [callLog]="log"></app-lead-call-log>
            </div>
          </ng-container>
        </td>

        <td>
          <button class="btn btn-link" (click)="release(row.lead)">
            Release
          </button>
          <button class="btn btn-primary btn-sm" (click)="showDetails(row.lead)">
            Show More...
          </button>
        </td>
      </tr>
    </q-table>
  </div>
</div>

<q-modal #releaseReassignModal title="Release or Reassign Leads" (close)="resetAction()">
  <div class="form-group">
    <div class="form-check-inline">
      <label class="form-check-label">
        <input type="radio" [(ngModel)]="action" value="release" class="form-check-input" name="releaseReassign" />
        Release (释放)
      </label>
    </div>
    <div class="form-check-inline">
      <label class="form-check-label">
        <input type="radio" [(ngModel)]="action" value="reassign" class="form-check-input" name="releaseReassign" />
        Reassign (分配给其他人)
      </label>
    </div>
  </div>

  <div class="form-group">
    <label>Which leads?</label>
    <select class="form-control" [(ngModel)]="actionLeadsType">
      <option [value]="actionLeadsTypes.Untouched">{{actionLeadsTypes.Untouched}}</option>
      <option [value]="actionLeadsTypes.Touched">{{actionLeadsTypes.Touched}}</option>
      <option [value]="actionLeadsTypes.All">{{actionLeadsTypes.All}}</option>
    </select>
    <small class="form-text text-danger" *ngIf="getActionLeads().length === 0">
      There is no {{actionLeadsType}} to {{action}}.
    </small>
  </div>
  <ng-container *ngIf="action === 'reassign'">
    <div class="form-group">
      <label>Reassign to who?</label>
      <select class="form-control" [(ngModel)]="reassignTo">
        <option [value]="user" *ngFor="let user of usernames">{{user}}</option>
      </select>
    </div>
    <div class="text-right">
      <button class="btn btn-link" (click)="resetAction()">Cancel</button>
      <button class="btn btn-primary" [disabled]="!reassignTo || !getActionLeads().length" (click)="reassign()">OK</button>
    </div>
  </ng-container>
  <ng-container *ngIf="action === 'release' && getActionLeads().length > 0">
    <div class="alert alert-danger" *ngIf="actionLeadsType === actionLeadsTypes.Untouched">
      将会释放所有没有动过的销售目标餐馆(THIS WILL REMOVE ALL UNTOUCHED LEADS FROM YOUR LIST).
    </div>
    <div class="alert alert-danger" *ngIf="actionLeadsType === actionLeadsTypes.Touched">
      将会释放所有已动过的销售目标餐馆(THIS WILL REMOVE ALL TOUCHED LEADS FROM YOUR LIST).
    </div>
    <div class="alert alert-danger" *ngIf="actionLeadsType === actionLeadsTypes.All">
      将会释放所有销售目标餐馆(THIS WILL REMOVE ALL LEADS FROM YOUR LIST).
    </div>
    <div class="text-right">
      <button class="btn btn-link" (click)="resetAction()">Cancel</button>
      <button class="btn btn-primary" [disabled]="!getActionLeads().length" (click)="releaseMulti()">OK</button>
    </div>
  </ng-container>
</q-modal>

<q-modal #leadModal>
  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
    <span aria-hidden="true">×</span>
  </button>
  <app-lead-details [lead]="selectedLead"></app-lead-details>
</q-modal>
