<div class="action-bar" *qIf="hasSelection()">
  <button class="btn btn-primary" (click)="scanGoogle()">
    <i class="fab fa-searchengin"></i> Craw Google Info</button>
</div>
<h1 class="text-center">Lead Management</h1>
<div class="text-right pb-2">
  <ng-container *ngFor="let filter of ['classifications', 'serviceProviders', 'zipCode', 'city', 'state', 'rating']">
    <button *ngIf="searchFilter[filter]" class="btn btn-outline-success" (click)="removeFilter(filter)">{{searchFilter[filter]}}
      <span class="text-danger">âœ•</span>
    </button>
  </ng-container>

  <button class="btn btn-info" (click)="filter()">
    <i class="fas fa-filter"></i> Filter</button>
  <button class="btn btn-primary" (click)="createNew()">+ Add New Lead</button>
</div>
<div class="table-responsive">
  <table class="table table-hover">
    <thead>
      <tr>
        <th scope="col">
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="check-all" [checked]="isAllSelected()" (change)="toggleSelectAll()">
            <label class="form-check-label" for="check-all">Name</label>
          </div>
        </th>
        <th scope="col">Street</th>
        <th scope="col">City</th>
        <th scope="col">Zip Code</th>
        <th scope="col">State</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let lead of leads">
        <th scope="row">
          <div class="form-check">
            <input type="checkbox" class="form-check-input" [id]="'check-' + lead._id" [checked]="selectionSet.has(lead._id)" (change)="toggleSelection(lead)">
            <label class="form-check-label" [attr.for]="'check-' + lead._id">{{lead.name}}</label>
          </div>
        </th>
        <td>{{(lead.address.stree_number || '') + ' ' + lead.address.route}}</td>
        <td>{{lead.address.locality}}</td>
        <td>{{lead.address.postal_code}}</td>
        <td>{{lead.address.administrative_level_2}}</td>
        <td class="text-right">
          <button class="btn btn-link py-0" (click)="view(lead)">
            <i class="fas fa-bars"></i>
          </button>
        </td>
      </tr>
    </tbody>
  </table>
</div>
<q-modal [title]="leadInEditing._id ? 'Edit Restaurant Lead: ' + leadInEditing.name : 'Create New Restaurant Lead' " #editingModal>
  <q-form-builder [object]="leadInEditing" [showDelete]="leadInEditing._id" [fieldDescriptors]="formFieldDescriptors" (submit)="formSubmit($event)"
    (remove)="formRemove($event)" (cancel)="editingModal.hide()">
    <q-address-picker #myAddressPicker></q-address-picker>
    <div class="form-group">
      <label for="address-apt">Extra (APT, Suite etc.)</label>
      <input type="text" class="form-control" id="address-apt" placeholder="eg. APT 101 or Suite 300" [(ngModel)]="addressApt">
    </div>
  </q-form-builder>
</q-modal>

<q-modal [title]="'Filter Leads' " #filterModal>
  <q-form-builder [object]="searchFilter" [showDelete]="false" [fieldDescriptors]="filterFieldDescriptors" (submit)="filterSubmit($event)"
    (cancel)="filterModal.hide()">
    <div class="form-group">
      <label>Review Rating</label>
      <div>
        <q-rating [(ngModel)]="searchRating"></q-rating>
      </div>

    </div>
  </q-form-builder>
</q-modal>

<q-modal [title]="leadInEditing.name" #viewModal>
  <table class="table">
    <tbody>
      <tr>
        <th class="nowrap border-top-0">

          <b>Address</b>
        </th>
        <td class="border-top-0">
          <a href="https://www.google.com/maps/search/?api=1&query={{leadInEditing.address?.getShortAddress()}}" target="_blank">
            {{leadInEditing.address?.getShortAddress()}}
            <i *ngIf="leadInEditing.address?.place_id" class="fas fa-check text-success"></i>
          </a>
          <div *ngIf="!(leadInEditing.address?.place_id)">
            <button class="btn btn-outline-primary" (click)="injectGoogleAddress(leadInEditing)" [qLoading]="apiRequesting">
              <i class="fas fa-map-marker-alt"></i> Inject Google Address</button>
          </div>
        </td>
      </tr>
      <tr>
        <th class="nowrap border-top-0">
          <b>Phones</b>
        </th>
        <td class="border-top-0">
          <a *ngFor="let phone of leadInEditing.phones" href="tel:{{phone}}">{{phone | tel}}&nbsp;&nbsp;</a>
        </td>
      </tr>
      <tr>
        <th class="nowrap border-top-0">
          <b>Email</b>
        </th>
        <td class="border-top-0">
          <a *ngIf="leadInEditing.email" href="mailto:{{leadInEditing.email}}">{{leadInEditing.email}}</a>
        </td>
      </tr>
      <tr>
        <th class="nowrap border-top-0">
          <b>Website</b>
        </th>
        <td class="border-top-0">
          <a *ngIf="leadInEditing.website" href="{{leadInEditing.website}}" target="_blank">{{leadInEditing.website}}</a>
        </td>
      </tr>
      <tr>
        <th class="nowrap border-top-0">
          <b>Classifications</b>
        </th>
        <td class="border-top-0"> {{(leadInEditing.classifications || []).join(', ')}}</td>
      </tr>
    </tbody>
  </table>
  <hr>
  <div class="text-center">
    <div *ngIf="leadInEditing.rating || leadInEditing.gmbWebsite || leadInEditing.gmbOpen; else no_gmb">
      <app-gmb-info [gmbInfo]="leadInEditing"></app-gmb-info>
    </div>
    <ng-template #no_gmb>
      <i class="fas fa-exclamation-triangle text-warning"></i> Missing GMB info
      <i class="far fa-hand-point-right"></i>&nbsp;&nbsp;
      <button class="btn btn-outline-primary" (click)="crawGoogle(leadInEditing)" [qLoading]="apiRequesting">
        <i class="fab fa-searchengin"></i> Craw Google</button>
    </ng-template>
  </div>


</q-modal>
